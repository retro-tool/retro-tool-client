---
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: "<%= defined?(name) ? name : %Q{#{app_name}-#{app_role}} %>"
  namespace: xing-retro
  annotations:
    com.xing.dynamic-config: enabled
spec:
  revisionHistoryLimit: 5
  replicas: <%= replicas %>
  selector:
    matchLabels:
      app: "<%= defined?(name) ? name : %Q{#{app_name}-#{app_role}} %>"
      appName: "<%= app_name if defined?(app_name) %>"
      appRole: "<%= app_role if defined?(app_role) %>"
  # nginx-ingress-controller config update interval is 3 seconds
  minReadySeconds: 4
  strategy:
    rollingUpdate:
      maxUnavailable: <%= replicas == 1 ? 0 : 1 %>
      maxSurge: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: "<%= defined?(name) ? name : %Q{#{app_name}-#{app_role}} %>"
        appName: "<%= app_name if defined?(app_name) %>"
        appRole: "<%= app_role if defined?(app_role) %>"
      annotations:
        com.xing.ci-deployment.timestamp: "<%= deployment_id %>"
        com.xing.logjam.app.name: "<%= logjam_name %>"
    spec:
      terminationGracePeriodSeconds: 60
      imagePullSecrets:
      - name: quay-pull-secret
      containers:
      - name: "<%= defined?(name) ? name : %Q{#{app_name}-#{app_role}} %>"
        image: <%= "quay.dc.xing.com/xing-retro/xing-retro-client:#{tag}" %>
        args: <%= args %>
        ports:
        - containerPort: 80
        envFrom: <%= partial "envFrom" %>
        <% if defined?(environment) && !environment.empty? %>
        env: [<%= environment.map { |k,v| %Q({name: "#{k.to_s}", value: "#{v.to_s}"}) }.join(",") %>]
        <% end %>
        resources:
          requests:
            cpu: '<%= cpu %>'
            memory: '<%= memory %>'
        lifecycle:
          preStop:
            exec:
              # sleep >3s is necessary to let nginx ingress controller remove the endpoint
              command: ["/bin/sleep", "4"]
